<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Scripting Guide | ImmyDocs</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.c79fdf9a.css" as="style"><link rel="preload" href="/assets/js/app.2b153654.js" as="script"><link rel="preload" href="/assets/js/3.fbaec080.js" as="script"><link rel="preload" href="/assets/js/21.8aa69f9b.js" as="script"><link rel="prefetch" href="/assets/js/10.bd723c19.js"><link rel="prefetch" href="/assets/js/11.fd2d870a.js"><link rel="prefetch" href="/assets/js/12.d1869659.js"><link rel="prefetch" href="/assets/js/13.acda56fa.js"><link rel="prefetch" href="/assets/js/14.6220cdba.js"><link rel="prefetch" href="/assets/js/15.d289ad29.js"><link rel="prefetch" href="/assets/js/16.5a19d957.js"><link rel="prefetch" href="/assets/js/17.8614e8a4.js"><link rel="prefetch" href="/assets/js/18.003b9818.js"><link rel="prefetch" href="/assets/js/19.9a75765e.js"><link rel="prefetch" href="/assets/js/20.e4d9d7f4.js"><link rel="prefetch" href="/assets/js/22.ea1fca32.js"><link rel="prefetch" href="/assets/js/4.0aa5ec06.js"><link rel="prefetch" href="/assets/js/5.0d3a908b.js"><link rel="prefetch" href="/assets/js/6.f4ddba4c.js"><link rel="prefetch" href="/assets/js/7.91b888a1.js"><link rel="prefetch" href="/assets/js/8.21dcb625.js"><link rel="prefetch" href="/assets/js/9.8bde7756.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.729fc4ac.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c79fdf9a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">ImmyDocs</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div> <a href="https://github.com/immense/immybot-documentation" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div> <a href="https://github.com/immense/immybot-documentation" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>What's New</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/releases.html" class="sidebar-link">Releases</a></li></ul></section></li><li><a href="/" aria-current="page" class="sidebar-link">Getting Started</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/#preface" class="sidebar-link">Preface</a></li><li class="sidebar-sub-header"><a href="/#overview" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/#create-your-trial-instance" class="sidebar-link">Create your trial instance</a></li><li class="sidebar-sub-header"><a href="/#setup-your-first-computer" class="sidebar-link">Setup your first Computer</a></li><li class="sidebar-sub-header"><a href="/#recommended-deployments" class="sidebar-link">Recommended Deployments</a></li><li class="sidebar-sub-header"><a href="/#testing-with-windows-sandbox" class="sidebar-link">Testing with Windows Sandbox</a></li><li class="sidebar-sub-header"><a href="/#adding-users" class="sidebar-link">Adding Users</a></li><li class="sidebar-sub-header"><a href="/#user-roles" class="sidebar-link">User Roles</a></li><li class="sidebar-sub-header"><a href="/#terminology" class="sidebar-link">Terminology</a></li><li class="sidebar-sub-header"><a href="/#deployment-resolution" class="sidebar-link">Deployment Resolution</a></li></ul></li><li><a href="/FAQ.html" class="sidebar-link">Frequently Asked Questions</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FAQ.html#what-if-i-don-t-know-which-user-will-be-using-the-computer" class="sidebar-link">What if I don’t know which user will be using the computer?</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#can-immy-join-azuread" class="sidebar-link">Can Immy join AzureAD?</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#can-immy-help-migrate-my-customers-to-azuread-from-on-premises-environments" class="sidebar-link">Can Immy help migrate my customers to AzureAD from On-Premises environments?</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#domain-join-didn-t-work-what-gives" class="sidebar-link">Domain Join didn’t work, what gives?</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#why-are-my-computers-stuck-in-identification" class="sidebar-link">Why are my computers stuck in Identification</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#can-you-target-devices-in-azure-groups" class="sidebar-link">Can you target devices in Azure Groups?</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#how-do-i-uninstall-the-immyagent" class="sidebar-link">How do I uninstall the ImmyAgent?</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#how-are-we-able-to-define-which-version-of-windows-is-installed-during-the-initial-setup" class="sidebar-link">How/are we able to define which version of Windows is installed during the initial setup?</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#since-immy-bot-doesn-t-use-an-iso-does-it-require-a-device-to-have-the-ability-to-have-2-usb-devices-plugged-in-one-for-a-windows-iso-and-one-for-the-immybot-ppkg" class="sidebar-link">Since Immy.Bot doesn’t use an ISO, does it require a device to have the ability to have 2 USB devices plugged in? One for a Windows ISO and one for the ImmyBot ppkg?</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#does-immy-rely-on-the-windows-preboot-for-drivers-during-initial-deployment-or-does-the-immybot-agent-installer-have-drivers" class="sidebar-link">Does Immy rely on the Windows preboot for drivers during initial deployment, or does the ImmyBot agent installer have drivers?</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#does-immy-s-setup-process-support-a-usb-nic-for-wifi-if-so-how-do-we-present-those-drivers-to-immy-or-do-we-even-need-to" class="sidebar-link">Does Immy’s setup process support a USB NIC for WiFi?  If so, how do we present those drivers to Immy, or do we even need to?</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#sentinelone-how-do-we-define-which-site-immy-bot-places-the-agent-in-during-installation-of-the-s1-agent" class="sidebar-link">SentinelOne - How do we define which site Immy.Bot places the agent in during installation of the S1 agent?</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#are-there-any-repository-limits-for-software-deployments-either-to-the-size-of-custom-software-or-number-of-custom-installers-we-can-upload" class="sidebar-link">Are there any repository limits for software deployments?  Either to the size of custom software or number of custom installers we can upload?</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#employee-profile-caching-during-on-boarding-is-this-supported-if-so-how" class="sidebar-link">Employee profile caching during on-boarding - is this supported?  If so/how?</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#for-purchasing-immy-do-you-guys-prefer-credit-card-or-invoice-would-you-rather-us-pay-monthly-or-can-we-pay-all-upfront" class="sidebar-link">For purchasing Immy, do you guys prefer Credit card or invoice? Would you rather us pay monthly, or can we pay all upfront?</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#is-immy-able-to-group-devices-and-then-do-role-based-deployments-to-them-i-assume-this-is-done-by-tags" class="sidebar-link">Is Immy able to group devices and then do role based deployments to them? I assume this is done by tags?</a></li><li class="sidebar-sub-header"><a href="/FAQ.html#bitlocker-does-this-write-the-key-to-azure-ad-by-chance" class="sidebar-link">BitLocker - does this write the key to Azure AD by chance?</a></li></ul></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Advanced</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/scripts.html" aria-current="page" class="active sidebar-link">Scripting Guide</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/scripts.html#best-practices" class="sidebar-link">Best Practices</a></li><li class="sidebar-sub-header"><a href="/scripts.html#script-types" class="sidebar-link">Script Types</a></li><li class="sidebar-sub-header"><a href="/scripts.html#script-execution-contexts" class="sidebar-link">Script Execution Contexts</a></li><li class="sidebar-sub-header"><a href="/scripts.html#variables" class="sidebar-link">Variables</a></li><li class="sidebar-sub-header"><a href="/scripts.html#scripting-frequently-asked-questions" class="sidebar-link">Scripting Frequently Asked Questions</a></li><li class="sidebar-sub-header"><a href="/scripts.html#configuration-task-helper-functions" class="sidebar-link">Configuration Task Helper Functions</a></li></ul></li><li><a href="/immy-commands.html" class="sidebar-link">Metascripts / Cloud Scripts</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/immy-commands.html#common-commands" class="sidebar-link">Common Commands</a></li><li class="sidebar-sub-header"><a href="/immy-commands.html#metascript-commands" class="sidebar-link">Metascript Commands</a></li><li class="sidebar-sub-header"><a href="/immy-commands.html#filterscript-commands" class="sidebar-link">Filterscript Commands</a></li><li class="sidebar-sub-header"><a href="/immy-commands.html#software-auto-update-commands" class="sidebar-link">Software Auto Update Commands</a></li><li class="sidebar-sub-header"><a href="/immy-commands.html#cw-automate-commands" class="sidebar-link">CW Automate Commands</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Integrations</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/connectwise-automate-integration-setup.html" class="sidebar-link">ConnectWise Automate</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/connectwise-automate-integration-setup.html#create-immybot-role" class="sidebar-link">Create ImmyBot Role</a></li><li class="sidebar-sub-header"><a href="/connectwise-automate-integration-setup.html#create-immybot-user" class="sidebar-link">Create ImmyBot User</a></li><li class="sidebar-sub-header"><a href="/connectwise-automate-integration-setup.html#enable-google-mfa-for-immybot-user" class="sidebar-link">Enable Google MFA for ImmyBot User</a></li><li class="sidebar-sub-header"><a href="/connectwise-automate-integration-setup.html#add-rmm-link-for-cw-automate" class="sidebar-link">Add RMM Link for CW Automate</a></li><li class="sidebar-sub-header"><a href="/connectwise-automate-integration-setup.html#import-your-customers" class="sidebar-link">Import your customers</a></li></ul></li><li><a href="/connectwise-control-integration-setup.html" class="sidebar-link">ConnectWise Control</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/connectwise-control-integration-setup.html#install-immybot-extension-for-control" class="sidebar-link">Install ImmyBot Extension for Control</a></li><li class="sidebar-sub-header"><a href="/connectwise-control-integration-setup.html#create-rmmlink-for-control" class="sidebar-link">Create RMMLink for Control</a></li><li class="sidebar-sub-header"><a href="/connectwise-control-integration-setup.html#import-your-customers" class="sidebar-link">Import your customers</a></li><li class="sidebar-sub-header"><a href="/connectwise-control-integration-setup.html#troubleshooting" class="sidebar-link">Troubleshooting</a></li></ul></li><li><a href="/connectwise-manage-integration-setup.html" class="sidebar-link">ConnectWise Manage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/connectwise-manage-integration-setup.html#create-an-immybot-role-with-the-following-permissions" class="sidebar-link">Create an ImmyBot Role with the following permissions</a></li><li class="sidebar-sub-header"><a href="/connectwise-manage-integration-setup.html#create-an-api-member" class="sidebar-link">Create an API Member</a></li><li class="sidebar-sub-header"><a href="/connectwise-manage-integration-setup.html#plugin-the-api-keys-in-immybot" class="sidebar-link">Plugin the API Keys in ImmyBot</a></li></ul></li><li><a href="/ncentral-integration-setup.html" class="sidebar-link">N-Central Integration</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ncentral-integration-setup.html#create-immybot-role-in-n-central" class="sidebar-link">Create ImmyBot Role in N-Central</a></li><li class="sidebar-sub-header"><a href="/ncentral-integration-setup.html#create-immybot-user-in-n-central" class="sidebar-link">Create ImmyBot user in N-Central</a></li><li class="sidebar-sub-header"><a href="/ncentral-integration-setup.html#login-to-the-new-immybot-user-to-get-mfa-code-and-accept-eula" class="sidebar-link">Login to the new ImmyBot user to get MFA code and accept EULA</a></li><li class="sidebar-sub-header"><a href="/ncentral-integration-setup.html#add-integration-for-n-central" class="sidebar-link">Add integration for N-Central</a></li><li class="sidebar-sub-header"><a href="/ncentral-integration-setup.html#import-your-customers" class="sidebar-link">Import your customers</a></li><li class="sidebar-sub-header"><a href="/ncentral-integration-setup.html#troubleshooting" class="sidebar-link">Troubleshooting</a></li></ul></li><li><a href="/csp-preconsent-instructions.html" class="sidebar-link">AzureAD/365</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/csp-preconsent-instructions.html#create-an-app-registration" class="sidebar-link">Create an App Registration</a></li><li class="sidebar-sub-header"><a href="/csp-preconsent-instructions.html#grant-permissions" class="sidebar-link">Grant Permissions</a></li><li class="sidebar-sub-header"><a href="/csp-preconsent-instructions.html#create-client-secret" class="sidebar-link">Create Client Secret</a></li><li class="sidebar-sub-header"><a href="/csp-preconsent-instructions.html#granular-delegated-admin-permissions-gdap" class="sidebar-link">Granular Delegated Admin Permissions (GDAP)</a></li><li class="sidebar-sub-header"><a href="/csp-preconsent-instructions.html#add-to-admin-agents-group-legacy-dap" class="sidebar-link">Add to Admin Agents Group (Legacy DAP)</a></li><li class="sidebar-sub-header"><a href="/csp-preconsent-instructions.html#copy-the-application-client-id-and-client-secret-value-into-the-form-in-immybot" class="sidebar-link">Copy the Application (client) ID and Client Secret Value into the form in ImmyBot.</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="scripting-guide"><a href="#scripting-guide" class="header-anchor">#</a> Scripting Guide</h1> <h2 id="best-practices"><a href="#best-practices" class="header-anchor">#</a> Best Practices</h2> <ul><li>Look for a script that already does what you want. There is a lot of good logic in the built in function scripts</li> <li>Have a machine you can test on</li> <li>Have a <em>separate</em> machine to test your sanity if you bork your first machine</li> <li>Test by clicking Open Debugger in the logs
<ul><li>This gives you all available parameters on the left so you can test the script in its natural context</li> <li>You can quickly revise the script here until it works as expected</li> <li>Saving the script here saves it permanently</li></ul></li> <li>Don’t hardcode paths to installer or license files, instead rely on $InstallerFile and $LicenseFilePath</li> <li>Don’t hardcode license values or other sensitive information, instead utilize $LicenseValue or a custom parameter</li> <li>Avoid (where possible) installers that have client specfic licenses or customizations built in
<ul><li>If a generic installer isn't available (BitDefender) use Dynamic Versions (and potentially a URL parameter) to specify the download URL per customer or perhaps use an API to find the URL for the given customer</li> <li>If the URL requires authentication, use a custom Download script to perform the authenticated download (CrowdStrike/SentinelOne)</li></ul></li> <li>Don’t repeat yourself. Leverage function scripts to reuse code</li> <li>Include code to verify that the script did what it intended to do
<ul><li>For Tasks, implement a “test” script</li> <li>For Software, make sure your Detection method works, and optionally implement a Test script to verify things are in working order
<ul><li>When a software Test script returns $false, ImmyBot will re-install the software.</li></ul></li></ul></li> <li>Use Metascripts, especially if your script needs to restart the machine or access APIs like IT Glue and therefore will contain sensitive data like API keys</li> <li>Use throw “The bad thing that happened, what user should do” to prevent cascading failure. That message will be shown to the user in a prominent location so they can take corrective action</li> <li>Tasks have a “test” mechanism that should return $true or $false to indicate compliance</li></ul> <p><strong>While it may be cumbersome to write additional logic to verify your work, the reward of knowing exactly how many machines are or are not compliant with your desired state is worth it. Without it, you are flying blind. With it, you know exactly how many machines require additional attention, giving you the opportunity to write better code that handles more edge cases. See the Helper Function section to see how we make your life easier.</strong></p> <h2 id="script-types"><a href="#script-types" class="header-anchor">#</a> Script Types</h2> <p>A script will have a specific type.  This type determines which variables and commands will be available in the script.</p> <h3 id="software-detection"><a href="#software-detection" class="header-anchor">#</a> Software Detection</h3> <p>Software Detection scripts are used to determine whether an existing software is present and what version it may be.</p> <p>Avoid custom detection scripts where possible. Software with a custom detection script can't be matched to pre-existing inventory data on the machine, making it difficult to report on how many machines have the software already. Further, the &quot;Assignable&quot; software tab won't work since that matches the detection method to existing inventory data. However if your software doesn't create an entry in Add/Remove Programs, you may have no choice but to use a custom detection script. It is important to note that a lot of software creates hidden entries under Add/Remove Programs, ImmyBot inventories these hidden entries, further reducing the need for custom detection scripts.</p> <p>When you write your custom detection script, your best bet is to find a exe or dll file under Program Files&lt;software name&gt; or ProgramData&lt;softwarename&gt; that shows the version when you right click on it and go to Properties. To retrieve this version use a script similar to the following:</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token function">Get-Command</span> <span class="token string">&quot;C:\Program Files*\&lt;softwarename&gt;\mysoftware.exe&quot;</span> <span class="token operator">-</span>ErrorAction SilentlyContinue <span class="token punctuation">|</span> <span class="token operator">%</span><span class="token punctuation">{</span> <span class="token variable">$_</span><span class="token punctuation">.</span>Version<span class="token punctuation">.</span>ToString<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre></div><p>If there is no exe or dll file containing the version, perhaps there is a .ini, .config, .json or .xml file that contains the installed version.</p> <p>If all else fails, you can simply return &quot;1.0&quot; if a file associated to the software exists.</p> <p>These scripts  <strong>must return a string that will cast to a valid <code>System.Version</code></strong>.
Returning an actual <code>System.Version</code> will fail. (Although we may correct this in the future)
For example</p> <div class="language- extra-class"><pre class="language-text"><code>$version = [String]&quot;1.2.3&quot;
return $version
</code></pre></div><p>will work, but currently</p> <div class="language- extra-class"><pre class="language-text"><code>$version = [System.Version]&quot;1.2.3&quot;
return $version
</code></pre></div><p>will fail.</p> <h3 id="software-auto-update-deprecated-use-dynamic-versions-instead"><a href="#software-auto-update-deprecated-use-dynamic-versions-instead" class="header-anchor">#</a> Software Auto Update (Deprecated, use dynamic versions instead)</h3> <p>These scripts are useful for automatically adding new versions for a software.
Script should return a <code>$SoftwareVersion</code> object.</p> <div class="language- extra-class"><pre class="language-text"><code>$SoftwareVersion = @{}
$SoftwareVersion.url = $LatestPackage.OriginFile.OriginUri
$SoftwareVersion.displayVersion = $VersionFromMsi
return $SoftwareVersion
</code></pre></div><h3 id="software-version-action"><a href="#software-version-action" class="header-anchor">#</a> Software Version Action</h3> <p>These scripts can be used on a software version for installation, post-installation, uninstallation, post-uninstallation, testing, and upgrade scripts.</p> <h3 id="maintenance-task"><a href="#maintenance-task" class="header-anchor">#</a> Maintenance Task</h3> <p>These scripts are available only on maintenance tasks.</p> <h3 id="metascript-deployment-target"><a href="#metascript-deployment-target" class="header-anchor">#</a> Metascript Deployment Target</h3> <p>These scripts are used on deployments as a target.</p> <p>They <strong>must return <code>$true</code> or <code>$false</code></strong>.</p> <p>A value of <code>$true</code> indicates that the computer applies to this deployment.  A value of <code>$false</code> indicates that the computer does not apply to this deployment.</p> <h3 id="filter-script-deployment-target"><a href="#filter-script-deployment-target" class="header-anchor">#</a> Filter Script Deployment Target</h3> <p>These scripts are used on deployments as a target.</p> <p>They <strong>must return a <code>Computer[]</code> array</strong>.</p> <p>The deployment will only apply to computers specified in the returned array.</p> <h2 id="script-execution-contexts"><a href="#script-execution-contexts" class="header-anchor">#</a> Script Execution Contexts</h2> <p>A script will have a specific execution context.  This context determines how the script gets run.</p> <h3 id="system"><a href="#system" class="header-anchor">#</a> System</h3> <p>The script runs on the computer under the system user.</p> <h3 id="user"><a href="#user" class="header-anchor">#</a> User</h3> <p>The script runs on the computer under a specific user.</p> <h3 id="metascript"><a href="#metascript" class="header-anchor">#</a> Metascript</h3> <p>The script runs on the server in the context of a specific computer.</p> <h3 id="cloudscript"><a href="#cloudscript" class="header-anchor">#</a> Cloudscript</h3> <p>The script runs on the server in the context of a specific tenant.</p> <h2 id="variables"><a href="#variables" class="header-anchor">#</a> Variables</h2> <p>Avoid setting these variables yourself or having variables with similar names.</p> <h3 id="azuretenantid"><a href="#azuretenantid" class="header-anchor">#</a> $AzureTenantId</h3> <p><code>[string]</code> The Azure Principal Id of the computer's tenant.</p> <h4 id="accessible-in"><a href="#accessible-in" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Detection</li> <li>Software Auto Update</li> <li>Software Version Action</li> <li>Maintenance Task Setter</li> <li>Metascript Deployment Target</li> <li>Filterscript Deployment Target</li></ul> <h3 id="computername"><a href="#computername" class="header-anchor">#</a> $ComputerName</h3> <p><code>[string]</code> Name of the computer the session is running against</p> <h4 id="accessible-in-2"><a href="#accessible-in-2" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Detection</li> <li>Software Auto Update</li> <li>Software Version Action</li> <li>Maintenance Task Setter</li> <li>Metascript Deployment Target</li></ul> <h3 id="detectionstring"><a href="#detectionstring" class="header-anchor">#</a> $DetectionString</h3> <p><code>[string]</code> String used to find the software in the registry</p> <h4 id="accessible-in-3"><a href="#accessible-in-3" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Version Action</li></ul> <h3 id="displayname"><a href="#displayname" class="header-anchor">#</a> $DisplayName</h3> <p><code>[string]</code> Display Name of the Software Version</p> <h4 id="accessible-in-4"><a href="#accessible-in-4" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Version Action</li></ul> <h3 id="displayversion"><a href="#displayversion" class="header-anchor">#</a> $DisplayVersion</h3> <p><code>[System.Version]</code> version of the software being deployed <code>1.2.3.4</code></p> <h4 id="accessible-in-5"><a href="#accessible-in-5" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Version Action</li></ul> <h3 id="installerfile"><a href="#installerfile" class="header-anchor">#</a> $InstallerFile</h3> <p><code>[string]</code> Full path to the installer file itself</p> <h4 id="accessible-in-6"><a href="#accessible-in-6" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Version Action</li></ul> <h3 id="installerfolder"><a href="#installerfolder" class="header-anchor">#</a> $InstallerFolder</h3> <p><code>[string]</code> Full path to the folder the installer file can be found in</p> <h4 id="accessible-in-7"><a href="#accessible-in-7" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Version Action</li></ul> <h3 id="installerlogfile"><a href="#installerlogfile" class="header-anchor">#</a> $InstallerLogFile</h3> <p><code>[string]</code> Suggested full path for log file. When used Immy will get the content of this file for you and display it in our logs.</p> <h4 id="accessible-in-8"><a href="#accessible-in-8" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Version Action</li></ul> <h3 id="isportable"><a href="#isportable" class="header-anchor">#</a> $IsPortable</h3> <p><code>[boolean]</code> 'True' or 'False' indicating whether the current computer is a laptop/tablet</p> <h4 id="accessible-in-9"><a href="#accessible-in-9" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Detection</li> <li>Software Auto Update</li> <li>Software Version Action</li> <li>Maintenance Task</li> <li>Metascript Deployment Target</li></ul> <h3 id="licensefilepath"><a href="#licensefilepath" class="header-anchor">#</a> $LicenseFilePath</h3> <p><code>[string]</code> Full path to the license file for the software (from the Deployment) Note: Software must be marked 'Licensed' and Software Version must indicate that it requires a License File and an Deployment applicable to this user/computer must specify a license file.</p> <h4 id="accessible-in-10"><a href="#accessible-in-10" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Version Action</li></ul> <h3 id="licensevalue"><a href="#licensevalue" class="header-anchor">#</a> $LicenseValue</h3> <p><code>[string]</code> From Deployment. Used for software that requires a key. Alternative usage could be to use this to hold additional command line parameters to customize installation for different computers. Software must be marked as Licensed for this variable to be replaced.</p> <h4 id="accessible-in-11"><a href="#accessible-in-11" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Version Action</li></ul> <h3 id="method"><a href="#method" class="header-anchor">#</a> $Method</h3> <p><code>[string]</code> Will be a value consisting of <code>[ &quot;get&quot; | &quot;set&quot; | &quot;test&quot; ]</code> that can be used in Combined Task scripts.</p> <h4 id="accessible-in-12"><a href="#accessible-in-12" class="header-anchor">#</a> Accessible in</h4> <ul><li>Maintenance Task</li></ul> <h3 id="primarypersonazureprincipalid"><a href="#primarypersonazureprincipalid" class="header-anchor">#</a> $PrimaryPersonAzurePrincipalId</h3> <p><code>[Guid]</code> User's unique identifier in Azure</p> <h4 id="accessible-in-13"><a href="#accessible-in-13" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Detection</li> <li>Software Auto Update</li> <li>Software Version Action</li> <li>Maintenance Task</li> <li>Metascript Deployment Target</li></ul> <h3 id="primarypersonemail"><a href="#primarypersonemail" class="header-anchor">#</a> $PrimaryPersonEmail</h3> <p><code>[string]</code> Mail Address of the person that most frequently uses this computer</p> <h4 id="accessible-in-14"><a href="#accessible-in-14" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Detection</li> <li>Software Auto Update</li> <li>Software Version Action</li> <li>Maintenance Task</li> <li>Metascript Deployment Target</li></ul> <h3 id="productcode"><a href="#productcode" class="header-anchor">#</a> $ProductCode</h3> <p><code>[string]</code> Product code of the version being deployed</p> <h4 id="accessible-in-15"><a href="#accessible-in-15" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Version Action</li></ul> <h3 id="software"><a href="#software" class="header-anchor">#</a> $Software</h3> <p><code>[Software]</code> The software that is running the auto update script.</p> <h4 id="accessible-in-16"><a href="#accessible-in-16" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Auto Update</li></ul> <h3 id="softwarename"><a href="#softwarename" class="header-anchor">#</a> $SoftwareName</h3> <p><code>[string]</code> Name of the Software</p> <h4 id="accessible-in-17"><a href="#accessible-in-17" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Detection</li> <li>Software Auto Update</li></ul> <h3 id="softwareversions"><a href="#softwareversions" class="header-anchor">#</a> $SoftwareVersions</h3> <p><code>[ICollection&lt;SoftwareVersion&gt;]</code> The software versions of the software.</p> <h4 id="accessible-in-18"><a href="#accessible-in-18" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Auto Update</li></ul> <h3 id="tenantname"><a href="#tenantname" class="header-anchor">#</a> $TenantName</h3> <p><code>[string]</code> Name of company the computer belongs to</p> <h4 id="accessible-in-19"><a href="#accessible-in-19" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Detection</li> <li>Software Auto Update</li> <li>Software Version Action</li> <li>Maintenance Task</li> <li>Metascript Deployment Target</li></ul> <h3 id="upgradecode"><a href="#upgradecode" class="header-anchor">#</a> $UpgradeCode</h3> <p><code>[string]</code> Upgrade code of the software</p> <h4 id="accessible-in-20"><a href="#accessible-in-20" class="header-anchor">#</a> Accessible in</h4> <ul><li>Software Detection</li> <li>Software Auto Update</li></ul> <h2 id="scripting-frequently-asked-questions"><a href="#scripting-frequently-asked-questions" class="header-anchor">#</a> Scripting Frequently Asked Questions</h2> <h3 id="can-i-use-custom-parameters-in-my-scripts"><a href="#can-i-use-custom-parameters-in-my-scripts" class="header-anchor">#</a> Can I use custom parameters in my scripts?</h3> <p>Yes. Add parameters to the Task your script is associated to. If this is a software install script, associate the task to the software as a &quot;Configuration Task&quot;, and all parameters are passed into the Install scripts</p> <h3 id="can-i-deploy-files-along-with-my-scripts"><a href="#can-i-deploy-files-along-with-my-scripts" class="header-anchor">#</a> Can I deploy files along with my scripts?</h3> <p>Yes. Tasks have a “File” parameter type. Immy will download the file and provide the path to the file in variable.</p> <h3 id="can-i-deploy-a-script-to-all-of-my-computers"><a href="#can-i-deploy-a-script-to-all-of-my-computers" class="header-anchor">#</a> Can I deploy a script to all of my computers?</h3> <p>Yes, you do this by creating a Task. We strongly recommend your task includes a ‘Test’ so Immy can check its work and provide reporting on the effectiveness of your script.</p> <h3 id="why-do-i-have-to-create-a-configuration-task-to-get-custom-parameters-into-my-software"><a href="#why-do-i-have-to-create-a-configuration-task-to-get-custom-parameters-into-my-software" class="header-anchor">#</a> Why do I have to create a Configuration Task to get custom parameters into my Software?</h3> <ul><li>Some software can only be configured at install time by providing command line parameters to the installer, think Antivirus products.</li> <li>Some software can only be configured after they are installed, think VPN Profiles</li> <li>Some software can go either way (Generally by manipulating config files or registry values)</li></ul> <p>Let’s say your Software package accepts command line parameters at install time. You would create a Configuration Task with those parameters without implementing the scripts on that Task. ImmyBot will pass the parameters into the install script.</p> <p>Later you need to reconfigure this software on lots of machines. You discover that the parameters you passed into the installer are ultimately held as registry values (Duo Logon Provider is like this). At this time you would implement the scripts on the Software’s Configuration Task. These scripts task will test the existing registry values against the desired ones, and set them to the desired value, and then re-test to verify.</p> <h3 id="how-does-immy-get-the-latest-version-of-software"><a href="#how-does-immy-get-the-latest-version-of-software" class="header-anchor">#</a> How does Immy get the latest version of software?</h3> <p>This is done via “Dynamic Versions”. Rather than upload the latest installer for every version of a piece of software, create a dynamic versions script that returns the most current version number, and the URL to download it. Reader, Zoom, 7zip, Chrome, Edge, Firefox, Bluebeam, Citrix, Egnyte,  and many more already have dynamic version scripts defined. This allows Immy to keep these items up to date on all your machines.</p> <h2 id="configuration-task-helper-functions"><a href="#configuration-task-helper-functions" class="header-anchor">#</a> Configuration Task Helper Functions</h2> <p>We provide helper functions for common tasks like Registry and configuration file manipulation</p> <p>When used in the context of a Task, these functions honor the $method variable containing the mode the script should be run in (‘test’, ‘set’, or ‘get’)</p> <p>**These must be run from the Metascript context</p> <h3 id="get-windowsregistryvalue-registryshould-be"><a href="#get-windowsregistryvalue-registryshould-be" class="header-anchor">#</a> Get-WindowsRegistryValue | RegistryShould-Be</h3> <h4 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h4> <p>Get-WindowsRegistryValue fetches the value of the specified Path and Name, and RegistryShould-Be tests and sets the value, creating missing keys/values if required</p> <p>On average this saves 8-10 lines of PowerShell per registry value and makes your code significantly more readable</p> <h4 id="usage"><a href="#usage" class="header-anchor">#</a> Usage</h4> <ul><li>Microsoft Edge</li></ul> <h4 id="example"><a href="#example" class="header-anchor">#</a> Example</h4> <p>This assumes you have a parameter called ServerAddress</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token function">Get-WindowsRegistryValue</span> <span class="token operator">-</span>Path <span class="token string">&quot;HKLM:\Software\MySoftware&quot;</span> <span class="token operator">-</span>Name <span class="token string">&quot;ServerAddress&quot;</span> <span class="token punctuation">|</span> RegistryShould<span class="token operator">-</span>Be <span class="token operator">-</span>Value <span class="token variable">$ServerAddress</span>
</code></pre></div><h3 id="fileshould-be"><a href="#fileshould-be" class="header-anchor">#</a> FileShould-Be</h3> <h4 id="overview-2"><a href="#overview-2" class="header-anchor">#</a> Overview</h4> <p>This accepts the source file path as input and verifies the files exists in the destination path, overwriting if the hashes don't match</p> <h4 id="example-1-config-file"><a href="#example-1-config-file" class="header-anchor">#</a> Example 1 - Config File</h4> <p>This assumes you have created a parameter called ConfigFile</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token variable">$ConfigFile</span> <span class="token punctuation">|</span> FileShould<span class="token operator">-</span>Be <span class="token operator">-in</span> <span class="token string">&quot;C:\ProgramData\MySoftware&quot;</span>
</code></pre></div><h4 id="example-2-zip-file"><a href="#example-2-zip-file" class="header-anchor">#</a> Example 2 - Zip File</h4> <p>This assumes you have a parameter called ZippedConfig</p> <p>The following script will iterate recursively over the extracted files and place them in the target directory. It will verify the hash matches when in test mode.</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token comment"># ImmyBot will automatically extract the Zip file and put the path it extracted it to into a variable named $ZippedConfigFolder</span>
<span class="token function">dir</span> <span class="token variable">$ZippedConfigFolder</span> <span class="token operator">-</span>Recurse <span class="token punctuation">|</span> <span class="token function">select</span> <span class="token operator">-</span>Expand FullName <span class="token punctuation">|</span> <span class="token function">ForEach-Object</span> <span class="token punctuation">{</span>
  <span class="token variable">$FilePath</span> = <span class="token variable">$_</span>
  <span class="token variable">$FilePath</span> <span class="token punctuation">|</span> FileShould<span class="token operator">-</span>Be <span class="token operator">-in</span> <span class="token string">&quot;C:\Program Files*\MySoftware&quot;</span> 
<span class="token punctuation">}</span>
</code></pre></div><h3 id="xmlshould-be"><a href="#xmlshould-be" class="header-anchor">#</a> XMLShould-Be</h3> <p>Let's say your software has an XML file you need to change settings in.</p> <p>This assumes you have a parameter called ServerAddress</p> <h4 id="usage-2"><a href="#usage-2" class="header-anchor">#</a> Usage</h4> <ul><li>OpenDental</li> <li>SmartBoard</li></ul> <h4 id="example-2"><a href="#example-2" class="header-anchor">#</a> Example</h4> <p>See the scripts for OpenDental and SmartBoard for usage of this</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token variable">$ConfigFilePath</span> = <span class="token string">&quot;C:\ProgramData\MySoftware\configuration.xml&quot;</span>
<span class="token variable">$XML</span> = <span class="token function">Get-Content</span> <span class="token variable">$ConfigFilePath</span>
<span class="token variable">$XML</span> = <span class="token variable">$XML</span> <span class="token punctuation">|</span> XMLShould<span class="token operator">-</span>Be <span class="token operator">-</span>XPath <span class="token string">&quot;/ServerAddress&quot;</span> <span class="token operator">-</span>Value <span class="token variable">$ServerAddress</span>
<span class="token variable">$XML</span> <span class="token punctuation">|</span> <span class="token function">Set-Content</span> <span class="token variable">$ConfigFilePath</span> 
</code></pre></div><h3 id="hkcushould-be"><a href="#hkcushould-be" class="header-anchor">#</a> HKCUShould-Be</h3> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token function">Get-WindowsRegistryValue</span> <span class="token operator">-</span>Path <span class="token string">&quot;HKCU:\Software\Policies\OneDrive&quot;</span> <span class="token operator">-</span>Name EnableADAL <span class="token punctuation">|</span> HKCUShould<span class="token operator">-</span>Be 1
</code></pre></div><h3 id="shouldhave-one"><a href="#shouldhave-one" class="header-anchor">#</a> ShouldHave-One</h3> <p>One of the aggravating things about PowerShell is ensuring there is exactly one item in a variable</p> <p>Typically you would do something like this:</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token variable">$MatchingUsers</span> = <span class="token function">Get-ADUser</span> <span class="token punctuation">|</span> ?<span class="token punctuation">{</span><span class="token variable">$_</span><span class="token punctuation">.</span>SAMAccountName <span class="token operator">-like</span> <span class="token string">&quot;Admin*&quot;</span> <span class="token punctuation">}</span>
<span class="token variable">$MatchingUserCount</span> = <span class="token variable">$MatchingUsers</span> <span class="token punctuation">|</span> <span class="token function">measure</span> <span class="token punctuation">|</span> <span class="token function">select</span> <span class="token operator">-</span>Expand Count
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$MatchingUserCount</span> <span class="token operator">-eq</span> 0<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token string">&quot;No matching users found&quot;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$MatchingUserCount</span> <span class="token operator">-gt</span> 1<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token string">&quot;Multiple users found: <span class="token function">$<span class="token punctuation">(</span><span class="token variable">$MatchingUsers</span> <span class="token punctuation">|</span> <span class="token function">Out-String</span><span class="token punctuation">)</span></span>&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Is reduced to</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token variable">$MatchingUsers</span> = <span class="token function">Get-ADUser</span> <span class="token punctuation">|</span> ?<span class="token punctuation">{</span><span class="token variable">$_</span><span class="token punctuation">.</span>SAMAccountName <span class="token operator">-like</span> <span class="token string">&quot;Admin*&quot;</span> <span class="token punctuation">}</span>
<span class="token variable">$MatchingUsers</span> <span class="token punctuation">|</span> ShouldHave<span class="token operator">-</span>One
</code></pre></div><p>If you simply want to take the first element but warn if there are multiple, use the -TakeFirst switch</p> <div class="language-powershell extra-class"><pre class="language-powershell"><code><span class="token variable">$MatchingUsers</span> = <span class="token function">Get-ADUser</span> <span class="token punctuation">|</span> ?<span class="token punctuation">{</span><span class="token variable">$_</span><span class="token punctuation">.</span>SAMAccountName <span class="token operator">-like</span> <span class="token string">&quot;Admin*&quot;</span> <span class="token punctuation">}</span>
<span class="token variable">$MatchingUser</span> = <span class="token variable">$MatchingUsers</span> <span class="token punctuation">|</span> ShouldHave<span class="token operator">-</span>One <span class="token operator">-</span>TakeFirst
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/immense/immybot-documentation/edit/main/src/scripts.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/28/2022, 2:07:27 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/FAQ.html" class="prev">
        Frequently Asked Questions
      </a></span> <span class="next"><a href="/immy-commands.html">
        Metascripts / Cloud Scripts
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2b153654.js" defer></script><script src="/assets/js/3.fbaec080.js" defer></script><script src="/assets/js/21.8aa69f9b.js" defer></script>
  </body>
</html>
